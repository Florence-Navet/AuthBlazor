@page "/account/login"
@using Microsoft.AspNetCore.Authorization

@attribute [AllowAnonymous]
@attribute [ExcludeFromInteractiveRouting]

@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject NavigationManager Navigation

<PageTitle>
	S'authentifier
</PageTitle>

<h1 class="text-center">
	S'authentifier
</h1>

@if (!string.IsNullOrEmpty(_error))
{
	<p class="text-danger">
		@_error
	</p>
}

<div class="row">
	<div class="col-12">
		<div class="card">
			<div class="card-body">
				<EditForm Model="Model" method="post" OnValidSubmit="LoginUser" FormName="loginform">
					<DataAnnotationsValidator />
					<h2>Se connecter</h2>
					<hr />
					<ValidationSummary class="text-danger" role="alert" />
					<div class="form-floating mb-3">
						<InputText @bind-Value="Model.Email" class="form-control"
						autocomplete="username" aria-required="true" placeholder="Email" />
						<label for="email" class="form-label">Email</label>
						<ValidationMessage For="() => Model.Email" class="text-danger" />
					</div>
					<div class="form-floating mb-3">
						<InputText type="password" @bind-Value="Model.Password" class="form-control" autocomplete="current-password" aria-required="true" placeholder="password" />
						<label for="password" class="form-label">Mot de passe</label>
						<ValidationMessage For="() => Model.Password" class="text-danger" />
					</div>
					<div class="checkbox mb-3">
						<label class="form-label">
							<InputCheckbox @bind-Value="Model.RememberMe" class="darker-border-checkbox form-check-input" />
							Se souvenir de moi
						</label>
					</div>
					<div>
						<button type="submit" class="w-100 btn btn-lg btn-primary">
							S'authentifier
						</button>
					</div>
					<div class="mt-2">
						<p>
							<a href="account/forgotpassword">Mot de passe oublié</a>
						</p>
					</div>
				</EditForm>
			</div>
		</div>
	</div>
</div>

@code {
	private string? _error;

	[SupplyParameterFromForm] private LoginModel Model { get; set; } = new();

	public async Task LoginUser()
	{
		_error = null;

		var user = await UserManager.FindByEmailAsync(Model.Email);
		if (user is null)
		{
			_error = "Email non trouvé";
			await InvokeAsync(StateHasChanged);
			return;
		}

		var result = await SignInManager.PasswordSignInAsync(user,
			Model.Password, Model.RememberMe, false);
		if (!result.Succeeded)
		{
			_error = "Mot de passe incorrect";
			await InvokeAsync(StateHasChanged);
			return;
		}

		Navigation.NavigateTo("/");
	}

	private class LoginModel
	{
		[Required(ErrorMessage = "L'adresse email doit être renseignée")]
		[EmailAddress]
		public string Email { get; set; } = "";

		[Required(ErrorMessage = "Le mot de passe doit être renseigné")]
		[DataType(DataType.Password)]
		public string Password { get; set; } = "";

		[Display(Name = "Se souvenir de moi")]
		public bool RememberMe { get; set; }
	}
}
